// server.js
import express from "express";
import mysql from "mysql2/promise"; // âœ… Use promise version
import cors from "cors";
import bcrypt from "bcrypt";

const app = express();
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// âœ… MySQL connection
const db = await mysql.createConnection({
  host: "localhost",
  user: "root",       // change if needed
  password: "Auto123!",
  database: "Recharge_db"
});

console.log("âœ… Connected to MySQL Database");

// ======================= REGISTER =======================
app.post("/api/register", async (req, res) => {
  try {
    const { username, password, role } = req.body;
   

    await db.query(
      "INSERT INTO users(username, password, role) VALUES (?, ?, ?)",
      [username, password, role || "user"]
    );

    res.json({ message: "Registered successfully" });
  } catch (err) {
    console.error("âŒ Register error:", err);
    res.status(500).json({ error: "Registration failed" });
  }
});

// ======================= LOGIN =======================
app.post("/api/login", async (req, res) => {
  try {
    const { username, password } = req.body;

    const [users] = await db.query("SELECT * FROM users WHERE username = ?", [username]);

    if (users.length === 0) return res.json({ error: "User not found" });

    const user = users[0];
      const passwordMatch =
      user.password.length < 30
        ? password === user.password
        : await bcrypt.compare(password, user.password);

    if (!passwordMatch) return res.json({ error: "Invalid password" });

    res.json({ message: "Login successful", role: user.role });
  } catch (err) {
    console.error("âŒ Login error:", err);
    res.json({ error: "Login failed" });
  }
});

// ======================= GET ALL RECHARGE DATA =======================
app.get("/api/recharge", async (req, res) => {
  try {
    const [results] = await db.query(`SELECT
  r.id,
  r.outlet_name,
  r.operator_name,
  r.operator_2,
  r.mobile_number,
  r.start_date,
  r.end_date,

  MAX(u.end_date) AS upgrade_end   -- ðŸ”¥ REQUIRED FOR UI

  FROM recharge_data r
  LEFT JOIN recharge_upgrades u
    ON u.recharge_id = r.id

  GROUP BY r.id;`);
    res.json(results);
  } catch (err) {
    console.error("âŒ Database query error:", err);
    res.status(500).json({ error: "Failed to fetch recharge data" });
  }
});

// ======================= INSERT NEW RECHARGE =======================
app.post("/api/insert", async (req, res) => {
  try {
    const data= req.body;
    const user = req.headers.user || "Unknown User";

    if ( !data.outlet_name ||
      !data.operator_name ||
      !data.operator_2 ||
      !data.mobile_number ||
      !data.start_date ||
      !data.end_date) {
      return res.status(400).json({ error: "Missing required fields" });
    }

    const [result] = await db.query(
      `INSERT INTO recharge_data 
        (outlet_name, operator_name, operator_2, mobile_number, start_date, end_date)
       VALUES (?, ?, ?, ?, ?, ?)`,
      [ data.outlet_name, data.operator_name, data.operator_2,
        data.mobile_number, data.start_date, data.end_date]
    );

    const newRecord = { 
      id: result.insertId,
      outlet_name: data.outlet_name,
      operator_name: data.operator_name,
      operator_2: data.operator_2,
      mobile_number: data.mobile_number,
      start_date: data.start_date,
      end_date: data.end_date
        };
      await logHistory(
      user,
      "INSERT",
      `Inserted new record: ${JSON.stringify(data)}`
    );
    res.status(201).json(newRecord);

  } catch (err) {
    console.error("âŒ Insert error:", err);
    res.status(500).json({ error: "Insert failed" });
  }
});

// ======================= UPDATE RECHARGE =======================
app.put("/api/update/:id", async (req, res) => {
  try {
    const { id } = req.params;
    const newData = req.body;
    const user = req.headers.user || "Unknown User";

    const [oldRows] = await db.query("SELECT * FROM recharge_data WHERE id = ?", [id]);
    const oldData = oldRows[0];

    if (!oldData) return res.status(404).json({ message: "Record not found" });

    await db.query(
      `UPDATE recharge_data 
       SET outlet_name = ?, operator_name = ?, operator_2 = ?, mobile_number = ?, start_date = ?, end_date = ?
       WHERE id = ?`,
      [
        newData.outlet_name,
        newData.operator_name,
        newData.operator_2,
        newData.mobile_number,
        newData.start_date,
        newData.end_date,
        id
      ]
    );

    const detailText =`
=== OLD DATA ===
${JSON.stringify(oldData, null, 2)}

=== NEW DATA ===
${JSON.stringify(newData, null, 2)}
`;
    await logHistory(user, "UPDATE", detailText);
    res.json({ message: "Record updated successfully!" });
  } catch (err) {
    console.error("âŒ Update error:", err);
    res.status(500).json({ error: "Update failed" });
  }
});


// ======================= DELETE RECHARGE =======================
app.delete("/api/recharge/:id", async (req, res) => {
  try {
    const { id } = req.params;
    const user = req.headers.user || "Unknown User";

    // Fetch old record before deleting
    const [rows] = await db.query("SELECT * FROM recharge_data WHERE id=?", [id]);
    const oldRecord = rows[0];
    await db.query("DELETE FROM recharge_data WHERE id = ?", [id]);

     await logHistory(
      user,
      "DELETE",
      `Deleted record: ${JSON.stringify(oldRecord)}`
    );
    res.json({ message: "Record deleted successfully!" });
  } catch (err) {
    console.error("âŒ Delete error:", err);
    res.status(500).json({ error: "Delete failed" });
  }
});

// ======================= UPGRADE =======================
app.post("/api/upgrade/:id", async (req, res) => {
  try {
    const rechargeId = req.params.id;
    const { plan_name, start_date, end_date } = req.body;
    const upgradedBy = req.headers.user || "Unknown";
    console.log("BODY:", req.body);
    console.log("PARAM ID:", req.params.id);

    if (!plan_name || !start_date || !end_date) {
      return res.status(400).json({ message: "Missing upgrade details" });
    }

    // 1ï¸âƒ£ Get outlet name
    const [rows] = await db.query(
      "SELECT outlet_name FROM recharge_data WHERE id = ?",
      [rechargeId]
    );

    if (rows.length === 0) {
      return res.status(404).json({ message: "Recharge record not found" });
    }

    const outletName = rows[0].outlet_name;

    // 2ï¸âƒ£ Insert upgrade record
    await db.query(
      `INSERT INTO recharge_upgrades
       (recharge_id, outlet_name, plan_name, start_date, end_date, upgraded_by)
       VALUES (?, ?, ?, ?, ?, ?)`,
      [rechargeId, outletName, plan_name, start_date, end_date, upgradedBy]
    );

    // 3ï¸âƒ£ Update main recharge dates
    await db.query(
      `UPDATE recharge_data
       SET start_date = ?, end_date = ?
       WHERE id = ?`,
      [start_date, end_date, rechargeId]
    );

    // 4ï¸âƒ£ Log history
    await logHistory(
      upgradedBy,
      "UPGRADE",
      `Upgraded plan for outlet ${outletName}: ${plan_name} (${start_date} â†’ ${end_date})`
    );

    res.json({ message: "Plan upgraded successfully" });

  } catch (err) {
    console.error("âŒ SQL ERROR:", err);
  return res.status(500).json({
    message: err.sqlMessage || err.message
  });
  }
});


// ======================= HISTORY LOG =======================
function logHistory(user_name,action,details){
  const query = "INSERT INTO history_log( user_name, action, details) VALUES ( ?, ?,?)";
  db.query(query, [user_name, action, details], (err) =>{
    if(err) console.error("History log error")
  })
}
app.get("/api/edit-count/:id", async (req, res) => {
  try {
    const id = req.params.id;

    const [rows] = await db.query(
       "SELECT COUNT(*) AS edits FROM history_log WHERE id = ? AND action = 'UPDATE'",
    [id]
    );

    res.json({ edits: rows[0].edits || 0 });
  } catch (err) {
    console.error("âŒ Edit count error:", err);
    res.status(500).json({ error: "Failed to fetch edit count" });
  }
});


app.get("/api/history", async (req, res) => {
  try {
    const role = req.headers.role;
    if (role !== "admin") return res.status(403).json({ message: "Access denied" });

    const { start, end } = req.query;
    let query = "SELECT * FROM history_log";
    let params = [];

    if (start && end) {
      // Include all timestamps from start 00:00:00 to end 23:59:59
      query += " WHERE timestamp >= ? AND timestamp <= ?";
      params.push(`${start} 00:00:00`, `${end} 23:59:59`);
    } else if (start) {
      query += " WHERE timestamp >= ?";
      params.push(`${start} 00:00:00`);
    } else if (end) {
      query += " WHERE timestamp <= ?";
      params.push(`${end} 23:59:59`);
    }

    query += " ORDER BY timestamp DESC";
    console.log("QUERY:", query, params);

    const [rows] = await db.query(query, params);
    res.json(rows);
  } catch (err) {
    console.error("âŒ History filter error:", err);
    res.status(500).json({ error: "Server error" });
  }
});

const prefixMap = {
  "Dispenser": "D",
  "Billing": "B",
  "Redeem": "R",
  "Internet issue":"I",
  "Camera display":"C",
  "Firewall":"F"
};

// Generate ticket ID (Category + Incremental Number)
async function generateTicketID(category) {
  const prefix = prefixMap[category] || "GEN";

  // 1. Read current counter
  const [rows] = await db.query(
    "SELECT counter FROM ticket_counters WHERE category = ?",
    [category]
  );

  let counter = rows.length ? rows[0].counter : 0;
  counter++;

  // 2. Update counter
  await db.query(
    "UPDATE ticket_counters SET counter = ? WHERE category = ?",
    [counter, category]
  );

  // 3. Format ticket: PREFIX-XXXX
  const formatted = String(counter).padStart(4, "0");
  return `${prefix}-${formatted}`;
}

// --- Add new complaint ---

app.post("/api/complaints", async (req, res) => {
  try {
    const { outlet_name, description, category, solution, attended_by, reported_to } = req.body;
    const ticket_id = await generateTicketID(category);
    await db.query(
      `INSERT INTO complaints 
      (ticket_id, outlet_name, description, category, solution, attended_by, reported_to)
      VALUES (?,?, ?, ?, ?, ?, ?)`,
      [ticket_id, outlet_name, description, category, solution, attended_by, reported_to]
    );
    res.json({ success: true, ticket_id });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: err.message });
  }
});


// --- Get all complaints ---
app.get("/api/complaints", async (req, res) => {
  try {
    const [rows] = await db.query(`
      SELECT 
        ticket_id,
        description,
        category,
        solution,
        attended_by,
        reported_to,
        status,
        status_change_count,
        created_at,
        outlet_name
      FROM complaints
      ORDER BY created_at DESC
    `);
    res.json(rows);
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: err.message });
  }
});


// --- Delete complaints ---
app.delete("/api/complaints/:ticket", async (req, res) => {
  try {
    const { ticket } = req.params;  // âœ… match the URL param
    const [rows] = await db.query(
      "SELECT * FROM complaints WHERE ticket_id = ?",
      [ticket]
    );
    const complaint = rows[0];

    if (!complaint) {
      return res.status(404).json({ message: "Complaint not found" });
    }

    await db.query("DELETE FROM complaints WHERE ticket_id = ?", [ticket]);

    res.json({ message: `Complaint ${ticket} deleted successfully!` });
  } catch (err) {
    console.error("âŒ Delete error:", err);
    res.status(500).json({ error: "Delete failed" });
  }
});


// --- Get complaint by ticket ID ---
app.get("/api/complaints/:ticket", async (req, res) => {
  try {
    const ticket = req.params.ticket;
    const [rows] = await db.query(
      "SELECT * FROM complaints WHERE ticket_id = ?",
      [ticket]
    );
    res.json(rows);
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: err.message });
  }
});

// --- Update complaint status ---
app.put("/api/status", async (req, res) => {
  try {
    const { ticket_id, status } = req.body;

    // Get current count
    const [rows] = await db.query(
      "SELECT status_change_count FROM complaints WHERE ticket_id = ?",
      [ticket_id]
    );

    if (rows.length === 0) {
      return res.status(404).json({ error: "Ticket not found" });
    }

    const count = rows[0].status_change_count;

    if (count >= 2) {
      return res.json({
        success: false,
        message: "Status change limit reached."
      });
    }

    // Update status + increment counter
    const [update] = await db.query(
      "UPDATE complaints SET status = ?, status_change_count = ? WHERE ticket_id = ?",
      [status, count + 1, ticket_id]
    );

    console.log("Rows updated:", update.affectedRows);  // DEBUG LINE
     console.log(ticket_id, count, status);

    res.json({ success: true });

  } catch (err) {
    console.error(err);
    res.status(500).json({ error: err.message });
  }
 
});



// --- Monthly report ---
app.get("/api/report/:year/:month", async (req, res) => {
  try {
    const { year, month } = req.params;
    const [rows] = await db.query(
      `SELECT * FROM complaints 
       WHERE YEAR(created_at) = ? AND MONTH(created_at) = ? 
       ORDER BY created_at DESC`,
      [year, month]
    );
    res.json(rows);
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: err.message });
  }
});





// ======================= START SERVER =======================
const PORT = 5000;
app.listen(PORT, () => console.log(`Server running at http://localhost:${PORT}`));

