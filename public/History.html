<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>History Log</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { font-family: 'Poppins', sans-serif; background:#f0f2f5; }
h1 { text-align:center; margin-top:20px; color:#145022; }
.container { max-width:1000px; margin-top:30px; }
#historyContent .entry { background:#fff; padding:15px; border-radius:8px; margin-bottom:10px; border-left:5px solid #145022; }
</style>
</head>
<body>

<h1><i class="bi bi-clock-history text-success"></i> Activity History Log</h1>

<div class="container">
  <!-- Filters -->
  <div class="row mb-3 align-items-end">
    <div class="col">
      <label class="form-label">Start Date</label>
      <input type="date" id="historyStart" class="form-control">
    </div>
    <div class="col">
      <label class="form-label">End Date</label>
      <input type="date" id="historyEnd" class="form-control">
    </div>
    <div class="col-auto d-flex gap-2">
      <button class="btn btn-success" onclick="applyHistoryFilter()">
        <i class="fas fa-filter"></i> Filter
      </button>
      <button class="btn btn-success" onclick="downloadHistoryExcel()" title="Download CSV">
        <i class="fas fa-download"></i> Download
      </button>
    </div>
  </div>

  <hr>
  <!-- Logs -->
  <div id="historyContent"></div>
</div>

<script>
const userRole = sessionStorage.getItem("userRole");
const username = sessionStorage.getItem("username");
if(!userRole){
  alert("Please log in first.");
  window.location.href = "login.html";
}

// --- Fetch and render history ---
async function loadHistory(start="", end=""){
  try{
    let url = "http://localhost:5000/api/history";
    const params = new URLSearchParams();
    if(start) params.append("start", start);
    if(end) params.append("end", end);
    if([...params].length) url += "?"+params.toString();

    const res = await fetch(url, { headers: { "role": userRole, "User": username } });
    if(res.status === 403){ alert("Access denied"); return; }

    const logs = await res.json();
    const container = document.getElementById("historyContent");
    container.innerHTML = "";
    if(!logs.length){ container.innerHTML = "<p>No activity found</p>"; return; }

    logs.forEach(log=>{
      const div = document.createElement("div");
      div.className = "entry";
      div.innerHTML = `
        <strong>User:</strong> ${log.user_name}<br>
        <strong>Action:</strong> ${log.action}<br>
        <strong>Description:</strong>
        <pre style="background:#f8f9fa; padding:8px; border-radius:5px; white-space:pre-wrap;">${log.details}</pre>
        <small style="color:#777;">${new Date(log.timestamp).toLocaleString()}</small>
      `;
      container.appendChild(div);
    });

  }catch(err){
    console.error(err);
    alert("Unable to load history.");
  }
}

function applyHistoryFilter(){
  const start = document.getElementById("historyStart").value;
  const end = document.getElementById("historyEnd").value;
  loadHistory(start, end);
}

// --- Download as Excel ---
function downloadHistoryExcel(){
  const container = document.getElementById("historyContent");
  const entries = [...container.querySelectorAll(".entry")];
  if(entries.length === 0){ alert("No history to download"); return; }

  const rows = entries.map(e=>{
    return {
      User: e.querySelector("strong:nth-of-type(1)").nextSibling.textContent.trim(),
      Action: e.querySelector("strong:nth-of-type(2)").nextSibling.textContent.trim(),
      Description: e.querySelector("pre").textContent.trim(),
      Timestamp: e.querySelector("small").textContent.trim()
    }
  });

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "History");
  XLSX.writeFile(wb, "history_log.xlsx");
}

// --- Auto load all history on page load ---
window.addEventListener("DOMContentLoaded", ()=>{
  loadHistory();
});
</script>
</body>
</html>
