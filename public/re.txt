// server.js
import express from "express";
import mysql from "mysql2";
import cors from "cors";

const app = express();
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// ✅ Configure your MySQL connection
const db = mysql.createConnection({
  host: "localhost",
  user: "root",        // change if needed
  password: "Auto123!",         // your MySQL password
  database: "Recharge_db"
});

db.connect(err => {
  if (err) {
    console.error("❌ MySQL Connection Error:", err);
    process.exit(1);
  } else {
    console.log("✅ Connected to MySQL Database");
  }
});

// ✅ Route to fetch all recharge data
app.get("/api/recharge", (req, res) => {
  db.query("SELECT * FROM recharge_data", (err, results) => {
    if (err) {
      console.error("❌ Database query error:", err);
      return res.status(500).json({ err });
    }
    res.json(results);
  });
});

// ✅ Optional: Route to add new records (for future use)
app.post("/api/insert", (req, res) => {
  const { outlet_name, operator_name, mobile_number, start_date, end_date } = req.body;

  // ✅ Validate input
  if (!outlet_name || !operator_name || !mobile_number || !start_date || !end_date) {
    return res.status(400).json({ error: "Missing required fields" });
  }

  // ✅ Auto-increment ID — don't include it in the insert query
  const query = `
    INSERT INTO recharge_data (outlet_name, operator_name, mobile_number, start_date, end_date)
    VALUES (?, ?, ?, ?, ?)
  `;

  db.query(query, [outlet_name, operator_name, mobile_number, start_date, end_date], (err, result) => {
    if (err) {
      console.error("❌ Database insert error:", err);
      return res.status(500).json({ error: "Insert failed" });
    }

    console.log("✅ Data inserted successfully!");

    // ✅ Send back the inserted record (using the auto-generated ID)
    const insertedId = result.insertId;
    const newRecord = { id: insertedId, outlet_name, operator_name, mobile_number, start_date, end_date };

    res.status(201).json(newRecord);
  });
});
app.put("/api/update/:id", (req, res) =>{
  const {id} = req.params;
  const {outlet_name, operator_name, mobile_number, start_date, end_date } =req.body;
  const query = `UPDATE recharge_data SET outlet_name = ?,operator_name= ?, mobile_number= ?, start_date= ?, end_date= ? WHERE id= ?`;
  db.query(query, [outlet_name, operator_name, mobile_number, start_date, end_date, id], (err, result)=>{
    if (err) {
      console.error("❌ Database update error:", err);
      return res.status(500).json({ error: "Update failed" });
    }

    console.log("✅ Data updated successfully!");
    res.json({ message: "Record updated successfully!" });

  });

});
app.delete("/api/recharge/:id", (req, res) =>{
  
  console.log("Delete request for id");
  const id = req.params.id;
  console.log("Delete request for id:", id);
   db.query("DELETE from recharge_data WHERE id= ?",[id], (err)=>{
    if (err) {
      console.error("❌ Database delete error:", err);
      return res.status(500).json({ error: "Delete failed" });
    }

    console.log("✅ Data deleted successfully!");
    res.json({ message: "Record deleted successfully!" });

  });

});

const PORT = 5000;
app.listen(PORT, () => console.log(`Server running at http://localhost:${PORT}`));